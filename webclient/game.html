<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style-game.css" />
  <title>Cosmic Katy</title>
</head>

 <script
        src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.3.0/dist/dotlottie-wc.js"
        type="module">
    </script>
  <script
        src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.3.0/dist/dotlottie-wc.js"
        type="module">
  </script>


<body>
  <div class="hidden">
    <div class="score-box decollage">
    Score Décollage : <span id="scoreDecollage">0</span>
    </div>
    <div class="score-box sabotage">
      Score Sabotage : <span id="scoreSabotage">0</span>
    </div>
      <div class="score-box general">
    Score Général : <span id="scoreGeneral">0</span>
    </div>
  </div>


  <div id="container">
    <div class="rowTop">
        <div class="colTop">
            <img src="" alt="qrCodeDecollage">
            <img class="logo" src="web-client-png/logo.png" alt=""> 
        </div>    
        <img src="" alt="qrCodeSabotage">
    </div>
  <div class="fuse-container">
    
    <img class="progress-frame" src="web-client-png/fuse.png" alt="Contour de la jauge" />

    <div class="progress-container">
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-label" id="progressLabel">50%</div>
      </div>
    </div>
  </div>

  <div id="containerbottom">
        <div id="decollage">
            <div id="connexionDecollage">
                <img class="icon" src="web-client-svg/icon.svg" alt="icon">
                <h3 class="count">11</h3>
            </div>
            <dotlottie-wc id="animationDecollage"
                src="https://lottie.host/cd33be5d-4994-4922-aa9f-7c3b693143c1/HZCZvtgXRV.lottie"
                autoplay
                speed="1"
                loop>
            </dotlottie-wc>
            <img class="imageDecollage" src="web-client-png/bulleDecollage copie.png" alt="">
        </div>
        <div id="sabotage">
            <div id="connexionSabotage">
                <img class="icon" src="web-client-svg/icon.svg" alt="icon">
                <h3 class="count">11</h3>
            </div>
                <dotlottie-wc id="animationSabotage"
                    src="https://lottie.host/049b8547-5945-40cf-8a13-36bfd07f6dc7/halWI7lkGu.lottie"
                    autoplay
                    loop>
                    </dotlottie-wc>
                </dotlottie-player>
            <img class="imageSabotage" src="web-client-png/bulleSabotage copie.png" alt="">
        </div>
  </div>



  
</body>
<script>
    let scoreDecollage = 0;
    let scoreSabotage = 0;
    let nbSaboteur = 0;
    let nbDecollage = 0;

    const decollageEl = document.getElementById("scoreDecollage");
    const sabotageEl = document.getElementById("scoreSabotage");
    const generalEl = document.getElementById("scoreGeneral");
    const progressBar = document.getElementById("progressBar");
    const progressLabel = document.getElementById("progressLabel");

    // Paramètres pour la barre
    const BAR_MIN = 0;
    const BAR_MAX = 100;
    const BAR_START = 50; // point de départ (milieu)

    function getBarPercent() {
      // On suppose que la différence max possible est +/-50
      // (donc score général de -50 à +50)
      // Tu peux ajuster cette valeur selon ton jeu !
      const DIFF_MAX = 50;

      let general = scoreDecollage - scoreSabotage;
      // Clamp la valeur entre -DIFF_MAX et +DIFF_MAX
      general = Math.max(-DIFF_MAX, Math.min(DIFF_MAX, general));
      // Transforme en pourcentage (0% = sabotage max, 100% = décollage max, 50% = égalité)
      return Math.round(50 + (general / (2 * DIFF_MAX)) * 100);
    }

    function updateDisplay() {
      decollageEl.textContent = scoreDecollage;
      sabotageEl.textContent = scoreSabotage;
      let general = scoreDecollage - scoreSabotage;
      generalEl.textContent = general;

      // Barre de progression
      const percent = getBarPercent();
      progressBar.style.height = percent + "%";
      progressLabel.textContent = percent + "%";

      // Vérification pour 100%
      if (percent >= 100) {
        window.location.href = "http://10.10.16.179/victoireDecollage.html"; // Remplacez par l’URL de votre nouvelle page
      }else if (percent <= 0) {
        window.location.href = "http://10.10.16.179/victoireSabotage.html";
    }
  }

    function connect() {
      const ws = new WebSocket(`ws://${location.hostname}:8080`);

      ws.addEventListener("message", async (ev) => {
        const [team, value] = (await ev.data.text()).split(",");
        const delta = parseInt(value, 10) || 0;


        if(team ==="spawn_saboteur"){
          nbSaboteur++;
          console.log("nbSaboteur : " + nbSaboteur);
        }

        if(team ==="close_saboteur"){
          nbSaboteur--;
          console.log("nbSaboteur : " + nbSaboteur);
        }

        
        if(team ==="spawn_decollage"){
          nbDecollage++;
          console.log("nbDecollage : " + nbSaboteur);
        }

        if(team ==="close_decollage"){
          nbDecollage--;
          console.log("nbDecollage : " + nbSaboteur);
        }

        
        if (team === "Decollage") {
          scoreDecollage += delta;
          console.log(team + " : +" + delta);
        } else if (team === "Sabotage") {
          scoreSabotage += Math.abs(delta);
          console.log(team + " : " + (delta >= 0 ? "+" : "") + delta);
        }



        updateDisplay();
      });

      ws.addEventListener("close", () => {
        setTimeout(connect, 1000);
      });
    }

    updateDisplay();
    connect();
  </script>
</html>
