<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Équipe Sabotage</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">Equipe sabotage</h1>
      <!--<p class="subtitle">Secoue ton téléphone pour siphonner l’essence de la fusée</p><!-->
    </header>

    <main class="game-container">

      <div class="bar-container">
        <div class="optimal-zone"></div>
        <div id="progress-bar"></div>
      </div>

      <div class="score">
        Score total : <span id="score">0</span><br>
        Dernier score : <span id="last-score">+0</span>
      </div>


      <button id="charge-button" aria-label="Charger"></button>
    </main>

    <footer class="buttonContent">
      <div class="buttonBorder">
        <img class="borderSvg" src="border.svg" alt="bordure bouton">
        <div class="bonus-progress-bar">
          <div class="bonus-progress-fill"></div>
        </div>
        <button class="buttonBonus" disabled>Bonus</button>
      </div>

      <p class="subButton">Progression x2</p>
    </footer>
  </div>

  <script>
    const progressBar = document.getElementById('progress-bar');
    const button = document.getElementById('charge-button');
    const lastScoreDisplay = document.getElementById('last-score');
    const scoreDisplay = document.getElementById('score'); // <-- AJOUT ICI
    const buttonBonus = document.querySelector('.buttonBonus');
    const bonusProgressFill = document.querySelector('.bonus-progress-fill');

    let progress = 0;
    let isPressing = false;
    let timer = 0;
    let score = 0;
    let interval = null;

    const maxProgress = 100;
    const optimalMin = 70;
    const optimalMax = 85;
    let bonusProgress = 0;

    let isBonusActive = false;
    let scoreMultiplier = 1;
    let scoreSinceLastBonus = 0; // Points gagnés depuis la dernière activation du bonus
    let lastScore = 0;

    function updateBar() {
      if (!isPressing) return;
      timer += 0.016;
      const acceleration = 1 + Math.pow(timer, 2.5);
      progress += acceleration * 1.5;

      if (progress >= maxProgress) {
        lastScore = -10 * scoreMultiplier;
        score += lastScore;
        resetCharge();
      }
      updateUI();
    }
    
    function updateUI() {
      progressBar.style.height = Math.min(progress, 100) + "%";
      lastScoreDisplay.textContent = (lastScore > 0 ? "+" : "") + lastScore;
      scoreDisplay.textContent = score; // <-- AJOUT ICI

      // Recharge la barre bonus uniquement avec les nouveaux points
      if (!isBonusActive) {
        bonusProgress = Math.min(100, (scoreSinceLastBonus / 100) * 100);
      }
      bonusProgressFill.style.width = bonusProgress + "%";
      buttonBonus.disabled = !(bonusProgress >= 100 && !isBonusActive);
    }


    function resetCharge() {
      progress = 0;
      timer = 0;
      clearInterval(interval);
      interval = null;
      updateUI();
    }

    function handleRelease() {
      if (!isPressing) return;
      isPressing = false;
      button.classList.remove('pressed');

      let points = 0;
      if (progress >= optimalMin && progress <= optimalMax) {
        const bonus = Math.round((progress - optimalMin) * 2);
        points = 10 + bonus;
      } else {
        points = Math.round(progress * 0.2);
      }

      lastScore = points * scoreMultiplier;
      score += lastScore;

      // On ajoute les points gagnés à scoreSinceLastBonus UNIQUEMENT si le bonus n'est pas actif
      if (!isBonusActive) {
        scoreSinceLastBonus += lastScore;
      }

      resetCharge();
    }

    // Empêche le menu contextuel (clic droit ou appui long)
    button.addEventListener('contextmenu', e => e.preventDefault());

    // Souris
    button.addEventListener('mousedown', e => {
      e.preventDefault();
      button.classList.add('pressed');
      if (interval) clearInterval(interval);
      isPressing = true;
      interval = setInterval(updateBar, 16);
    });
    button.addEventListener('mouseup', handleRelease);
    button.addEventListener('mouseleave', handleRelease);

    // Mobile
    button.addEventListener('touchstart', e => {
      e.preventDefault();
      button.classList.add('pressed');
      if (interval) clearInterval(interval);
      isPressing = true;
      interval = setInterval(updateBar, 16);
    });
    button.addEventListener('touchend', e => {
      e.preventDefault();
      handleRelease();
    });

    // Action du bouton bonus
    buttonBonus.addEventListener('click', () => {
      if (bonusProgress >= 100 && !isBonusActive) {
        isBonusActive = true;
        scoreMultiplier = 2;
        scoreSinceLastBonus = 0; // On repart de zéro pour la recharge
        bonusProgress = 100;
        updateUI();

        const duration = 5000; // 5 secondes
        const startTime = Date.now();

        function animateBonus() {
          const elapsed = Date.now() - startTime;
          if (elapsed >= duration) {
            // Fin du bonus
            isBonusActive = false;
            scoreMultiplier = 1;
            bonusProgress = 0;
            updateUI();
            return;
          }
          // Barre descend de 100% à 0%
          bonusProgress = 100 - (elapsed / duration) * 100;
          bonusProgressFill.style.width = bonusProgress + "%";
          requestAnimationFrame(animateBonus);
        }

        animateBonus();
      }
    });


  </script>
</body>
</html>
